---
title: "Map Creation"
author: "Troy Rowan"
date: "2020-07-09"
output: 
  html_document:
    code_folding: show
editor_options:
  chunk_output_type: inline
---


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(workflowr)
library(tidyverse)
library(rgdal)
library(raster)
library(fpc)
library(RStoolbox)
library(maps)
library(ggthemes)
library(cowplot)
library(purrr)
library(factoextra)
source(here::here("code", "map_functions.R"))

```


## Introduction
This uses k-means clustering and 30-year normal climate variables to divide the United States into distinct ecoregions.



## Reading in climate raster files

These originate from the [Prism Climate Group's](https://prism.oregonstate.edu/normals/) website in .bil format 
I was having issues with the rgdal package reading these or any other form, so had to read them and save as RDS files on Workstation (the only place where rgdal installs properly). SCP'd RDS files here, and these read in the individal environment variable rasters. 
```{r, eval=TRUE, warning=FALSE}
temp_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "temp_raster.RDS"))

precip_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "precip_raster.RDS"))

elev_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "elev_raster.RDS"))

dewpt_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "mean_dwpt_raster.RDS")
  )

min_vap_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "min_vpd_raster.RDS"))

max_vap_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "max_vpd_raster.RDS"))

min_temp_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "min_temp_raster.RDS"))

max_temp_raster = 
  readRDS(
    here::here("data", "prism_climate_data", "max_temp_raster.RDS"))
```

```{r, eval=TRUE, echo=TRUE, warning=FALSE}
stacked_raster = 
  stack(
    temp_raster,
    precip_raster,
    elev_raster,
    dewpt_raster,
    max_temp_raster,
    min_temp_raster,
    max_vap_raster,
    min_vap_raster
  ) 

threevar_stacked_raster = 
  stack(
    temp_raster,
    precip_raster,
    elev_raster
  )

```


## Identifying best K for full- and three-variable datasets

Using fpc::pamk(), K between 3 and 10
This doesn't run, but appears that based on the fviz_nbclust() function in that the appropriate 

It appears that k=2 is optimal 
```{r, eval=FALSE, warning=FALSE}
stacked_raster %>% 
  as.data.frame() %>% 
  na.omit() %>% 
  sample_n(20000) %>% 
  fviz_nbclust(FUNcluster = kmeans)+
  ggtitle("Full Environmental Data")
  #pamk(krange = 3:20, criterion="multiasw", usepam=FALSE, scaling=TRUE)

threevar_stacked_raster %>% 
  as.data.frame() %>% 
  na.omit() %>% 
  sample_n(20000) %>% 
  fviz_nbclust(FUNcluster = kmeans)+
  ggtitle("Three Environmental Variables ")
  #pamk(krange = 3:20, criterion="multiasw", usepam=FALSE, scaling=TRUE)
```

## K-means clustering climate maps

```{r K-means Maps, fig.height=4, fig.width=12, warning=FALSE}

# plotlist =
#   seq(2,10) %>% 
#   purrr::map(
#   ~plot_grid(
#     unsuperClass(stacked_raster,
#                nSamples=1000,
#                nClasses = .x,
#                norm=TRUE,
#                nStarts=5,
#                clusterMap=FALSE) %>%
#     .$map %>%
#     as.data.frame(xy=TRUE) %>%
#     mutate(layer = as.factor(layer)) %>%
#     kmeans_map()+
#       ggtitle(paste("All Variables, k =", .x)),
#     unsuperClass(threevar_stacked_raster,
#                  nSamples=1000,
#                  nClasses = .x,
#                  norm=TRUE,
#                  nStarts=5,
#                  clusterMap=FALSE) %>%
#     .$map %>%
#     as.data.frame(xy=TRUE) %>%
#     mutate(layer = as.factor(layer)) %>%
#     kmeans_map()+
#       ggtitle(paste("Three Variables, k =", .x))
#     )
#   )
#   
# saveRDS(plotlist, "../output/kmeans_plotlist.RDS")

readRDS(here::here("output", "kmeans_plotlist.RDS"))

```



