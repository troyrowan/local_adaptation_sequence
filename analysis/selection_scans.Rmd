---
title: "selection_scans"
author: "Troy Rowan"
date: "2020-09-30"
output: 
  html_document:
    code_folding: show
editor_options:
  chunk_output_type: inline
---

```{r, setup, include = FALSE}
set.seed(325333)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir=here::here())
library(workflowr)
library(knitr)
library(maps)
library(ggthemes)
library(cowplot)
library(purrr)
library(factoextra)
library(ggcorrplot)
library(factoextra)
library(here)
library(tidyverse)
library(lubridate)
library(fastDummies)
library(pedigree)
library(car)
library(zoo)
library(RcppRoll)
library(GenWin)
```


## Subsetting VCF files for analyses in `selscan`

Looking at oldest and youngest animals (randomly sampled 2018 individuals)

### Red Angus
```{r}
redangus = 
  read_csv("../output/200910_RAN/phenotypes/200910_RAN.info.csv")

ran_fam = 
  read_delim("../data/200910_RAN/200910_RAN.fam",
             delim = " ",
             col_names = c("FID", "international_id", "dad", "mom", "sex", "phenotype"))


print("Mean age of top 1000 Red Angus individuals")
redangus %>% 
  filter(international_id %in% ran_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>% 
  top_n(1000, wt = age) %>% 
  .$age %>% 
  mean()

print("Mean age of oldest 5000 Red Angus individuals")
redangus %>% 
  filter(international_id %in% ran_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  top_n(5000, wt = age) %>% 
  .$age %>% 
  mean()
```

### Writing out VCF Extract files for each dataset
These will pull our the selected individuals from the 850K imputed VCF files. 
We'll be performing selection scans on each of these datasets
1) 1000 oldest Red Angus animals
2) 5000 oldest Red Angus animals
3) 1000 random 2018-born individuals
4) 5000 random 2018-born individuals

```{r}
redangus %>% 
  filter(international_id %in% ran_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  top_n(1000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("../output/200910_RAN/subsets/200910_RAN.oldest_1000.txt")
  
redangus %>% 
  filter(international_id %in% ran_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  top_n(5000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("../output/200910_RAN/subsets/200910_RAN.oldest_5000.txt")

redangus %>% 
  filter(international_id %in% ran_fam$international_id,
         birth_year == 2018) %>%
  select(international_id, age) %>% 
  distinct() %>%
  sample_n(1000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("../output/200910_RAN/subsets/200910_RAN.young_1000.txt")
  
redangus %>% 
  filter(international_id %in% ran_fam$international_id,
         birth_year == 2018) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  sample_n(5000, wt = age)%>% 
  select(international_id) %>% 
  write_tsv("../output/200910_RAN/subsets/200910_RAN.young_5000.txt")

redangus %>% 
  filter(international_id %in% ran_fam$international_id,
         birth_year == 2018) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  sample_n(5000, wt = age)%>% 
  select(international_id) %>% 
  write_tsv("../output/200910_RAN/subsets/200910_RAN.young_5000.txt")

redangus %>% 
  filter(international_id %in% ran_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  select(international_id) %>% 
  distinct() %>% 
  write_tsv("output/200910_RAN/subsets/200910_RAN.all.txt")

```





## Simmental
```{r}
simmental = 
  read_csv("output/200907_SIM/phenotypes/200907_SIM.info.csv") %>%
  mutate(ASA_nbr = asa_nbr,
         dummyid = international_id) %>% 
  left_join(read_csv("data/200907_SIM/breeds.csv") %>% 
  pivot_wider(names_from = brd_cd, values_from = percent) %>% 
    replace(is.na(.), 0))

sim_fam = 
  read_delim("data/200907_SIM/200907_SIM.fam",
             delim = " ",
             col_names = c("FID", "international_id", "dad", "mom", "sex", "phenotype"))


print("Mean age of top 1000 Simmental individuals")
redangus %>% 
  filter(international_id %in% sim_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>% 
  top_n(1000, wt = age) %>% 
  .$age %>% 
  mean()

print("Mean age of oldest 5000 Simmental individuals")
redangus %>% 
  filter(international_id %in% sim_fam$international_id) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  top_n(5000, wt = age) %>% 
  .$age %>% 
  mean()
```

### Writing out VCF Extract files for each dataset
These will pull our the selected individuals from the 850K imputed VCF files. 
We'll be performing selection scans on each of these datasets
1) 100 oldest Red Angus animals
2) 100 oldest Red Angus animals (one per breeder)
3) 520 oldest Red Angus animals
4) 520 oldest Red Angus animals (one per breeder)
5) 2018-born individuals: one per breeder

```{r}
simmental %>% 
  filter(international_id %in% sim_fam$international_id) %>% 
  distinct(international_id, .keep_all = TRUE) %>%
  select(international_id, age) %>% 
  distinct() %>%
  top_n(1000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.oldest_1000.txt")
  
simmental %>% 
  filter(international_id %in% sim_fam$international_id) %>%
  distinct(international_id, .keep_all = TRUE) %>% 
  select(international_id, age) %>% 
  distinct() %>%
  top_n(5000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.oldest_5000.txt")

simmental %>% 
  filter(international_id %in% sim_fam$international_id,
         birth_year == 2018) %>%
  distinct(international_id, .keep_all = TRUE) %>%
  select(international_id, age) %>% 
  distinct() %>%
  sample_n(1000, wt = age) %>% 
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.young_1000.txt")
  
simmental %>% 
  filter(international_id %in% sim_fam$international_id,
         birth_year == 2018) %>% 
  distinct(international_id, .keep_all = TRUE) %>%
  select(international_id, age) %>% 
  distinct() %>%
  sample_n(5000, wt = age)%>% 
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.young_5000.txt")


simmental %>% 
  filter(international_id %in% sim_fam$international_id,
         SM == 1) %>% 
  distinct(international_id, .keep_all = TRUE) %>%
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.purebred.txt")

simmental %>% 
  filter(international_id %in% sim_fam$international_id,
         SM >= 0.05) %>% 
  distinct(international_id, .keep_all = TRUE) %>%
  select(international_id) %>% 
  write_tsv("output/200907_SIM/subsets/200907_SIM.somesim.txt")
```


# nSL (Number of Segregating Loci) % XP-nSL (Cross-population nSL)

After extensive exploration of the iHS statistic, I found that nSL is measuring basically the same thing (haplotype size) in a slightly different way (without the need for a recombination map. )


## Red Angus

Reading in Old and Young nSL data

Here, in addition to identifying significant SNPs, we're also calculating a window-based levels of significance similar to the approach in [the XP-nSL paper](https://www.biorxiv.org/content/10.1101/2020.05.19.104380v1.full#F2) to account for LD creating similar nSL scores. 

[The original nSL paper](https://academic.oup.com/mbe/article/31/5/1275/999180) doesn't do any sort of window-based significance cutoffs, opting simply to use the top 1% of variants 

```{r}
ran_nsl =
  read_tsv("output/200910_RAN/selscan/nsl/200910_RAN.all.nsl.out.100bins.norm.gz",
             col_names = c("SNP", "BP", "freq", "sl1", "sl0", "nsl", "norm_nsl", "sig")) %>% 
    mutate(CHR = as.numeric(str_split_fixed(SNP, ":", n = 4)[,1]),
           SNP = paste(CHR, BP, sep = ":"))

ran_xpnsl =
  read_tsv("output/200910_RAN/selscan/xpnsl/200910_RAN.xpnsl.out.norm.gz",
           col_names = c("SNP", "BP", "gpos", "p1", "sl1", "p2", "sl2", "xpnsl", "norm_xpnsl", "sig"),
           skip = 1) %>% 
    mutate(CHR = as.numeric(str_split_fixed(SNP, ":", n = 4)[,1]),
           CHRBP = paste(CHR, BP, sep = ":"))

ran_nsl_window = 
  read_tsv("output/200910_RAN/selscan/nsl/200910_RAN.all.nsl.windows.txt") %>% 
  mutate(nsl_win = abs(Wstat),
         SNP = paste(CHR, BP, sep = ":"))
```

### Distribution of Scores
Blue lines are top 1% of XP-nSL scores
Red lines are at 3, equivalent to 3 SD in this normalized statistic
```{r}
plot_grid(
  ran_nsl %>% 
    ggplot(aes(norm_nsl))+
    geom_histogram(bins = 100)+
    theme_cowplot()+
    geom_vline(xintercept = c(2.5, -2.5),
               color = "blue")+
    geom_vline(xintercept = c(3, -3),
               color = "red")+
    labs(x = "Normalized nSL", title = "All Red Angus nSL"),
  
  ran_xpnsl %>% 
    ggplot(aes(norm_xpnsl))+
    geom_histogram(bins = 100)+
    theme_cowplot()+
    geom_vline(xintercept = c(3, -3),
               color = "red")+
    geom_vline(xintercept = c(2.77, -2.77),
               color = "blue")+
    labs(x = "Normalized XP-nSL", title = "All Red Angus XP-nSL"),
  nrow = 2)
```

### Red Angus nSL Manhattan

```{r}
# plot_grid(
#   selscan_manhattans(ran_nsl %>% 
#                        filter(abs(norm_nsl) > 0.5), 
#                      col = norm_nsl)+
#     ggtitle("Norm nSL"),
#   selscan_manhattans(rn_nsl_window, col = Wstat)+
#     ggtitle("Windows"),
#   nrow = 2)

selscan_manhattans(ran_nsl %>% 
                       filter(abs(norm_nsl) > 1), 
                     col = abs(norm_nsl))
```

### XP-nSL Manhattan Plot
```{r}
ran_xpnsl %>% 
  selscan_manhattans(col = abs(norm_xpnsl))
```


### nSL x XP-nSL Manhattan

```{r}
plot_grid(
  ran_xpnsl %>% 
    filter(abs(norm_xpnsl) > 0.5) %>% 
    selscan_manhattans(col = abs(norm_xpnsl))+
    labs(y = "nSL", title = "Red Angus nSL"),
  ran_nsl %>% 
    filter(abs(norm_nsl) > 0.5) %>% 
    selscan_manhattans(col = abs(norm_nsl))+
    labs(y = "XP-nSL", title = "Red Angus XP-nSL"),
  nrow = 2)
```


## Comapring XP-nSL to GPSM betas

Basically no correlation between XP-nSL statistic and the betas in GPSM. 
```{r}
gpsm_xpnsl =
  left_join(ran_xpnsl, ran_gpsm_age) %>%
    select(SNP, b, norm_xpnsl)


cor(gpsm_xpnsl$b, abs(gpsm_xpnsl$norm_xpnsl), use = 'pairwise.complete.obs')
```

### Annotating selscan hits

#### Genes
```{r}
ran_nsl %>% 
  filter(abs(norm_nsl) > 3.5) %>% 
  gene_annotation() %>% 
    left_join(ran_nsl, 
              by = c("CHR", "BP")) %>% 
  select(-chr, -start_pos, -end_pos, -gene_biotype, -width, -strand, -upstream, -downstream) %>% 
  datatable()

ran_xpnsl %>% 
  filter(abs(norm_xpnsl) > 3.5) %>% 
  gene_annotation() %>% 
    left_join(ran_xpnsl, 
              by = c("CHR", "BP")) %>% 
  select(-chr, -start_pos, -end_pos, -gene_biotype, -width, -strand, -upstream, -downstream) %>% 
  select(gene_name) %>% distinct() %>% write_tsv("analysis/genes.txt")
  datatable()

ran_nsl_window %>% 
  top_frac(0.01, wt = abs(Wstat)) %>% 
  gene_annotation() %>% 
    left_join(ran_nsl, 
              by = c("CHR", "BP")) %>% 
  select(-chr, -start_pos, -end_pos, -gene_biotype, -width, -strand, -upstream, -downstream) %>% 
  datatable()
```

#### Gene Ontology Analysis

Gene ontology enrichment analysis using `gprofiler2::gost()` of gene names from GALLO annotation of log-transformed GPSM COJO hits

Significance threshold set at FDR < 0.10
##### nSL
```{r, eval }
ran_nsl_GO =
  ran_nsl %>% 
  filter(abs(norm_nsl) > 3.5) %>% 
  gene_annotation(search_bp = 50000) %>% 
    left_join(ran_nsl, 
              by = c("CHR", "BP")) %>% 
  select(-chr, -start_pos, -end_pos, -gene_biotype, -width, -strand, -upstream, -downstream) %>% 
  .$gene_name %>% unique() %>% 
  gost(query = ., 
      organism = "btaurus",
      user_threshold = 0.1,
      correction_method = "fdr")


gostplot(ran_nsl_GO, capped = TRUE, interactive = TRUE)
```


##### XP-nSL
```{r, eval }
ran_xpnsl_GO =
  ran_xpnsl %>% 
  filter(abs(norm_xpnsl) > 2.77) %>% 
  gene_annotation(search_bp = 50000) %>% 
    left_join(ran_nsl, 
              by = c("CHR", "BP")) %>% 
  select(-chr, -start_pos, -end_pos, -gene_biotype, -width, -strand, -upstream, -downstream) %>% 
  .$gene_name %>% unique() %>% 
  gost(query = ., 
      organism = "btaurus",
      user_threshold = 0.1,
      correction_method = "fdr")


gostplot(ran_xpnsl_GO, capped = TRUE, interactive = TRUE)
```
#### QTL Enrichments (genome)

##### nSL
```{r}
ran_nsl_qtls =
  ran_nsl %>%
  filter(abs(norm_nsl)>3) %>% 
  qtl_annotation() %>% 
  filter(QTL_type != "Milk") %>% select(CHR, BP, trait_ID, breed, p_value, bayes_value, Flank_Markers) %>%  View()
  group_by(CHR, BP, trait_ID) %>% 
  slice(1)

 ran_nsl_qtls%>% 
  qtl_enrich(qtl_db = qtl, qtl_file = ., qtl_type = "Name", enrich_type = "genome", nThreads = 2) %>% 
  arrange(adj.pval) %>% 
  datatable()
```

##### XP-nSL
```{r}
ran_xpnsl_qtls =
  ran_xpnsl %>%
  filter(abs(norm_xpnsl)>3) %>% 
  qtl_annotation() %>% 
  filter(QTL_type != "Milk")

 ran_xpnsl_qtls%>% 
  qtl_enrich(qtl_db = qtl, qtl_file = ., qtl_type = "Name", enrich_type = "genome", nThreads = 2) %>% 
  arrange(adj.pval) %>% 
  datatable()
```
#### QTL Enrichments (per-chromosome)
```{r}
ran_nsl %>%
  filter(abs(norm_nsl)>3.5) %>% 
  qtl_annotation() %>% 
  filter(QTL_type != "Milk") %>% 
  qtl_enrich(qtl_db = qtl, qtl_file = ., qtl_type = "Name", enrich_type = "chromosomes", nThreads = 2) %>% 
  arrange(adj.pval) %>% 
  datatable()
```



## Simmental

Reading in Simmental nSL Results Data
```{r}
pb_sim_nsl =
  read_tsv("output/200907_SIM/selscan/nsl/200907_SIM.purebred.nsl.out.100bins.norm.gz",
             col_names = c("SNP", "BP", "freq", "sl1", "sl0", "nsl", "norm_nsl", "sig")) %>% 
    mutate(CHR = as.numeric(str_split_fixed(SNP, ":", n = 4)[,1]),
           SNP = paste(CHR, BP, sep = ":"))
pb_sim_nsl_sigsnps =
  pb_sim_nsl %>% 
  filter(abs(norm_nsl)>3) %>% 
  .$SNP

pb_sim_nsl_window = 
  read_tsv("output/200907_SIM/selscan/nsl/200907_SIM.purebred.nsl.windows.txt") %>% 
  mutate(nsl_win = abs(Wstat),
         SNP = paste(CHR, BP, sep = ":"))

sim_nsl =
  read_tsv("output/200907_SIM/selscan/nsl/200907_SIM.somesim.nsl.out.100bins.norm.gz",
             col_names = c("SNP", "BP", "freq", "sl1", "sl0", "nsl", "norm_nsl", "sig")) %>% 
    mutate(CHR = as.numeric(str_split_fixed(SNP, ":", n = 4)[,1]),
           SNP = paste(CHR, BP, sep = ":"))
sim_nsl_window = 
  read_tsv("output/200907_SIM/selscan/nsl/200907_SIM.somesim.nsl.windows.txt") %>% 
  mutate(nsl_win = abs(Wstat),
         SNP = paste(CHR, BP, sep = ":"))
sim_nsl_sigsnps =
  sim_nsl %>% 
  filter(abs(norm_nsl)>3) %>% 
  .$SNP


sim_xpnsl =
  read_tsv("output/200907_SIM/selscan/xpnsl/200907_SIM.xpnsl.out.norm.gz") %>%
    rename(SNP = id, BP = pos, normnsl = normxpehh) %>% 
    mutate(CHR = as.numeric(str_split_fixed(SNP, ":", n = 4)[,1]),
           SNP = paste(CHR, BP, sep = ":"))
```

### Purebred nSL Manhattan
```{r}
plot_grid(
  selscan_manhattans(pb_sim_nsl %>% 
                       filter(abs(norm_nsl) > 0.5), 
                     col = norm_nsl)+
    ggtitle("Norm nSL"),
  selscan_manhattans(pb_sim_nsl_window, col = Wstat)+
    ggtitle("Windows"),
  nrow = 2)

selscan_manhattans(pb_sim_nsl %>% 
                       filter(abs(norm_nsl) > 1), 
                     col = abs(norm_nsl),
                   sigsnps = sim_nsl_sigsnps)
```

### Full Simmental
```{r}
plot_grid(
  selscan_manhattans(sim_nsl %>% 
                       filter(abs(norm_nsl) > 0.5), 
                     col = norm_nsl)+
    ggtitle("Norm nSL"),
  selscan_manhattans(sim_nsl_window, col = Wstat)+
    ggtitle("Windows"),
  nrow = 2)

selscan_manhattans(sim_nsl %>% 
                       filter(abs(norm_nsl) > 1), 
                     col = abs(norm_nsl),
                   sigsnps = pb_sim_nsl_sigsnps)
```






# SFS-based Selection Scans

## Extracting Simmental and Red Angus animals from 1KBulls dataset for use in SFS Selection Sweep Methods

Used this command to pull out 1K Bulls International IDs from imputation files: 
> zcat 200708_Run8_refbuild.T90_20.chr22.m3vcf.gz | head -n 8 | tail -n 1 | tr "\t" "\n" | grep "_HAP_1" | sed 's/_HAP_1//g' > /storage/hpc/group/UMAG/WORKING/tnr343/local_adaptation_sequence/data/1KBulls_ids.txt


This command was used to pull USA Simmental and Red Angus IDs from 1K Bulls list generated above:
> grep "SIMUSA" data/1KBulls_ids.txt > data/200907_SIM/sequenced_simmentals.txt
> grep "RANUSA" data/1KBulls_ids.txt > data/200910_RAN/sequenced_redangus.txt

We use all biallelic variants in these calculations to kepe the SFS as close to true as possible. 


## RAiSD analysis on 1KBulls  data


### Red Angus


```{r}
ran_raisd =
  seq(1,29) %>% 
    purrr::map(
      ~read_delim(paste0("output/200910_RAN/sfs_selection/RAiSD_Report.200910_RAN.chr", .x,".gz"),
                 skip = 1,
                 delim = "\t",
                 col_names = c("BP", "stat", "finish", "VAR", "SFS", "LD", "Mu")) %>% 
        filter(Mu > 50) %>% 
        mutate(CHR = .x,
               SNP = paste(CHR, BP, sep = ":"))) %>% 
    reduce(bind_rows)

ran_raisd_chip =
  seq(1,29) %>% 
    purrr::map(
      ~read_delim(paste0("output/200910_RAN/sfs_selection/RAiSD_Report.200910_RAN.chip.chr", .x,".gz"),
                 skip = 1,
                 delim = "\t",
                 col_names = c("BP", "stat", "finish", "VAR", "SFS", "LD", "Mu")) %>% 
        mutate(CHR = .x,
               SNP = paste(CHR, BP, sep = ":"))
      ) %>% 
    reduce(bind_rows)

ran_raisd_genes = 
  ran_raisd %>% 
  gene_annotation(search_bp = 0) %>% 
  filter(!is.na(gene_name)) %>% 
  left_join(ran_raisd)

ran_raisd_genes %>% 
  group_by(gene_name) %>% 
  top_n(1, wt = Mu) %>% View()

ran_raisd_genes %>% 
  filter(Mu > 10) %>% 
  selscan_manhattans(col = Mu)

ran_raisd %>%
  selscan_manhattans(col = Mu)+
  geom_hline(yintercept = 699,
             color = "red")
  
ran_raisd_chip %>% 
  filter(Mu > .1) %>% 
  selscan_manhattans(col = Mu)+
  geom_hline(yintercept = 7.94,
             color = "red")


ran_raisd_chip %>% 
  filter(Mu > 7.94) %>% 
  gene_annotation(search_bp = 10000) %>% 
  filter(!is.na(gene_name)) %>% 
  left_join(ran_raisd_chip)
```

### Simmental

```{r}
sim_raisd =
  seq(1,29) %>% 
    purrr::map(
      ~read_delim(paste0("output/200907_SIM/sfs_selection/RAiSD_Report.200907_SIM.chr", .x,".gz"),
                 skip = 1,
                 delim = "\t",
                 col_names = c("BP", "stat", "finish", "VAR", "SFS", "LD", "Mu")) %>% 
        filter(Mu > 50) %>% 
        mutate(CHR = .x,
               SNP = paste(CHR, BP, sep = ":"))
      ) %>% 
    reduce(bind_rows)

sim_raisd_genes = 
  sim_raisd %>% 
  gene_annotation(search_bp = 0) %>% 
  filter(!is.na(gene_name)) %>% 
  left_join(sim_raisd)

sim_raisd_genes %>% 
  group_by(gene_name) %>% 
  top_n(1, wt = Mu) %>% View()

sim_raisd %>% 
  selscan_manhattans(col = Mu)

filter(ran_raisd, Mu > 50) %>%
  selscan_manhattans(col = Mu)+
  geom_hline(yintercept = 699,
             color = "red")
  
ran_raisd %>% 
  top_frac(0.0001, wt = Mu) %>% 
  View()
```

